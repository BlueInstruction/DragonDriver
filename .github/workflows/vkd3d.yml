name: Build VKD3D-Proton for Winlator

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-vkd3d:
    runs-on: ubuntu-24.04
    steps:
      - name: Clone, Build and Package
        uses: Joshua-Ashton/arch-mingw-github-action@v8
        with:
          command: |
            # Install zip
            sudo pacman -S --noconfirm zip
            
            # Get latest release tag
            LATEST_TAG=$(curl -s https://api.github.com/repos/HansKristian-Work/vkd3d-proton/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
            
            # Clone repository
            git clone --recursive --branch "$LATEST_TAG" https://github.com/HansKristian-Work/vkd3d-proton.git
            cd vkd3d-proton
            
            # Build
            ./package-release.sh "$LATEST_TAG" build --no-package
            
            # Set variables
            VERSION=$(echo "$LATEST_TAG" | sed 's/^v//')
            SHA=$(git rev-parse --short HEAD)
            BUILD_DIR=$(find build -maxdepth 1 -type d -name "vkd3d-proton-*" | head -1)
            VERSION_CODE=$((RANDOM % 3))
            
            # Create package structure
            mkdir -p /tmp/pkg/system32
            mkdir -p /tmp/pkg/syswow64
            
            # Copy files
            cp "$BUILD_DIR/x64/"*.dll /tmp/pkg/system32/
            cp "$BUILD_DIR/x86/"*.dll /tmp/pkg/syswow64/
            
            # Create profile.json
            cat > /tmp/pkg/profile.json << EOF
            {
              "type": "VKD3D",
              "versionName": "${VERSION}-${SHA}",
              "versionCode": ${VERSION_CODE},
              "description": "vkd3d-proton",
              "files": [
                {
                  "source": "system32/d3d12.dll",
                  "target": "\${system32}/d3d12.dll"
                },
                {
                  "source": "system32/d3d12core.dll",
                  "target": "\${system32}/d3d12core.dll"
                },
                {
                  "source": "syswow64/d3d12.dll",
                  "target": "\${syswow64}/d3d12.dll"
                },
                {
                  "source": "syswow64/d3d12core.dll",
                  "target": "\${syswow64}/d3d12core.dll"
                }
              ]
            }
            EOF
            
            # Create wcp package
            cd /tmp/pkg
            zip -r "/github/workspace/vkd3d-proton-${VERSION}-${SHA}.wcp" .

      - name: Upload WCP
        uses: actions/upload-artifact@v4
        with:
          name: vkd3d-proton-winlator
          path: "*.wcp"
          if-no-files-found: error
