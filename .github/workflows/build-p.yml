name: Build Proton 10.0-4 ARM64EC

on:
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref (commit/tag) to build'
        required: true
        default: 'proton-10.0-4'
      version_name:
        description: 'Version name for the build'
        required: true
        default: '10.0-4-arm64ec'
      cleanup:
        description: 'Clean up build directories after build'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build-arm64ec:
    runs-on: ubuntu-latest
    
    env:
      UNI_KIND: "proton-10"
      REL_TAG_STABLE: "10.0-4"
      PATCH_DIR: "./patches"
      OUT_DIR: "./out"
      CLEANUP_BUILD: ${{ github.event.inputs.cleanup || 'false' }}
    
    steps:
    - name: Checkout Proton repository
      uses: actions/checkout@v4
      with:
        repository: 'ValveSoftware/Proton'
        ref: ${{ github.event.inputs.ref || 'proton-10.0-4' }}
        submodules: recursive
        fetch-depth: 0
    
    - name: Checkout build scripts
      uses: actions/checkout@v4
      with:
        path: build-scripts
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          .venv
        key: ${{ runner.os }}-proton-10.0-4-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-proton-10.0-4-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          ninja-build \
          python3 \
          python3-venv \
          python3-pip \
          xz-utils \
          build-essential \
          gcc-mingw-w64-i686 \
          g++-mingw-w64-i686 \
          llvm \
          clang \
          lld \
          patch \
          git \
          wine32 \
          wine64
        
        echo "=== Installed Tools ==="
        echo "GCC MinGW (i686): $(i686-w64-mingw32-gcc --version | head -n1)"
        echo "Clang: $(clang --version | head -n1)"
        echo "LLD: $(lld --version | head -n1)"
        echo "LLVM: $(llvm-strip --version | head -n1)"
        echo "Wine: $(wine --version)"
    
    - name: Install LLVM-MinGW (ARM64EC support)
      run: |
        # LLVM-MinGW ARM64EC
        LLVM_MINGW_VERSION="20240619"
        wget -q https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
        
        tar -xf llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64.tar.xz
        
        echo "$PWD/llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-ubuntu-20.04-x86_64/bin" >> $GITHUB_PATH
        
        echo "LLVM-MinGW installed successfully"
    
    - name: Verify ARM64EC toolchain
      run: |
        
        if command -v aarch64-w64-mingw32-gcc &> /dev/null; then
          echo "✓ ARM64EC toolchain (LLVM-MinGW) found"
          aarch64-w64-mingw32-gcc --version
        elif command -v clang &> /dev/null && command -v lld &> /dev/null; then
          echo "✓ Fallback to Clang/LLD for ARM64EC"
          clang --version
        else
          echo "::error::No ARM64EC toolchain found"
          exit 1
        fi
    
    - name: Setup Python environment
      run: |
        python3 -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip setuptools wheel
        pip install meson ninja
        
        echo "=== Python Environment ==="
        echo "Python: $(python --version)"
        echo "Meson: $(meson --version)"
        echo "Ninja: $(ninja --version)"
    
    - name: Prepare build directories
      run: |
        mkdir -p "$PATCH_DIR" "$OUT_DIR"
        
        
        cp build-scripts/scripts/build-proton-arm64ec.sh ./
        chmod +x build-proton-arm64ec.sh
        
        echo "=== Directory Structure ==="
        ls -la
    
    - name: Build Proton 10.0-4 ARM64EC
      run: |
        source .venv/bin/activate
        
        REF="${{ github.event.inputs.ref || 'proton-10.0-4' }}"
        VERSION="${{ github.event.inputs.version_name || '10.0-4-arm64ec' }}"
        FILENAME="proton-${REL_TAG_STABLE}-arm64ec.wcp.xz"
        
        echo "=== Build Configuration ==="
        echo "REF:          $REF"
        echo "VERSION:      $VERSION"
        echo "OUTPUT FILE:  $FILENAME"
        echo "CLEANUP:      $CLEANUP_BUILD"
        echo "=========================="
        
        
        ./build-proton-arm64ec.sh "$REF" "$VERSION" "$FILENAME"
    
    - name: Verify build output
      run: |
        OUTPUT_FILE="$OUT_DIR/proton-${REL_TAG_STABLE}-arm64ec.wcp.xz"
        
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "::error::Build artifact not found: $OUTPUT_FILE"
          exit 1
        fi
        
        echo "::notice::Build successful!"
        echo "::notice::File: $OUTPUT_FILE"
        echo "::notice::Size: $(du -h $OUTPUT_FILE | cut -f1)"
        
        if [ -f "$OUT_DIR"/*.sha256 ]; then
          echo "::notice::SHA256: $(cat $OUT_DIR/*.sha256)"
        fi
        
        
        echo "=== Archive Contents (first 30 files) ==="
        tar -tJf "$OUTPUT_FILE" | head -n 30
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: proton-${{ env.REL_TAG_STABLE }}-arm64ec-${{ github.run_number }}
        path: |
          ./out/*.wcp.xz
          ./out/*.sha256
        if-no-files-found: error
        retention-days: 30
        compression-level: 0
    
    - name: Upload build logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_x86/meson-logs/
          build_ec/meson-logs/
          *.log
        if-no-files-found: ignore
        retention-days: 7
    
    - name: Generate build summary
      if: success()
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## Proton 10.0-4 ARM64EC Build Successful!
        
        ### Build Information
        - **Version**: ${{ github.event.inputs.version_name || '10.0-4-arm64ec' }}
        - **Ref**: ${{ github.event.inputs.ref || 'proton-10.0-4' }}
        - **Build Number**: ${{ github.run_number }}
        - **Timestamp**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        
        ### Output Files
        - Main Archive: `proton-${{ env.REL_TAG_STABLE }}-arm64ec.wcp.xz`
        - Checksum: `proton-${{ env.REL_TAG_STABLE }}-arm64ec.wcp.xz.sha256`
        
        ### What's New in Proton 10.0-4
        - Updated vkd3d-proton to v3.0b
        - Updated Wine Mono to 10.4.1
        - Fixed numerous game-specific issues
        - Improved DualSense controller haptics support
        - Fixed 7.1 audio channel mapping
        
        ### Download
        The build artifacts are available in the **Artifacts** section of this workflow run.
        
        EOF
        
        if [ -f "./out/proton-${REL_TAG_STABLE}-arm64ec.wcp.xz" ]; then
          echo "- **Size**: $(du -h ./out/proton-${REL_TAG_STABLE}-arm64ec.wcp.xz | cut -f1)" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "./out"/*.sha256 ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SHA256 Checksum" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat ./out/*.sha256 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Create Release (for tagged builds)
      if: startsWith(github.event.inputs.ref, 'proton-')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.event.inputs.version_name }}
        name: Proton ${{ github.event.inputs.version_name }}
        draft: true
        body: |
          ## Proton ${{ github.event.inputs.version_name }} ARM64EC
          
          This is an ARM64EC build of Proton 10.0-4 for Windows on ARM devices.
          
          **Built from**: `${{ github.event.inputs.ref }}`  
          **Build date**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
        files: |
          ./out/*.wcp.xz
          ./out/*.sha256
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
