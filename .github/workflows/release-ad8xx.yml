name: Build Turnip A8xx

on:
  workflow_dispatch:

env:
  NDK_VERSION: "r29"
  MESA_REPO: "https://gitlab.freedesktop.org/mesa/mesa.git"
  MESA_BRANCH: "main"
  API_LEVEL: "34"

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip python3-mako \
            flex bison \
            meson ninja-build \
            pkg-config glslang-tools \
            clang lld llvm

      - name: Clone Mesa Source
        run: |
          git clone --depth 1 -b ${{ env.MESA_BRANCH }} ${{ env.MESA_REPO }} mesa_src

      - name: Setup Android NDK
        uses: android-actions/setup-android@v3

      - name: Install NDK Toolchain
        run: |
          sdkmanager "ndk;${{ env.NDK_VERSION }}"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Configure Meson (FPS Oriented)
        run: |
          cd mesa_src

          cat > android-cross.txt <<EOF
          [binaries]
          c = 'aarch64-linux-android${{ env.API_LEVEL }}-clang'
          cpp = 'aarch64-linux-android${{ env.API_LEVEL }}-clang++'
          ar = 'llvm-ar'
          strip = 'llvm-strip'
          ld = 'lld'

          [host_machine]
          system = 'android'
          cpu_family = 'aarch64'
          cpu = 'armv8'
          endian = 'little'
          EOF

          export PATH=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH
          SYSROOT=$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot

          FPS_CFLAGS="-O3 -flto=thin -ffast-math -fno-trapping-math -fno-signed-zeros -fomit-frame-pointer -funroll-loops -g0 -DNDEBUG -DTU_DISABLE_LRZ=1 -DTU_DEFAULT_GMEM=1"

          meson setup build-android \
            --cross-file android-cross.txt \
            -Dplatforms=android \
            -Dplatform-sdk-version=${{ env.API_LEVEL }} \
            -Dvulkan-drivers=freedreno \
            -Dfreedreno-kmds=kgsl \
            -Dbuildtype=release \
            -Dstrip=true \
            -Ddebug=false \
            -Db_lto=true \
            -Dshader-cache=disabled \
            -Dperfetto=false \
            -Dgallium-drivers= \
            -Dopengl=false \
            -Degl=disabled \
            -Dc_args="-I$SYSROOT/usr/include $FPS_CFLAGS" \
            -Dcpp_args="-I$SYSROOT/usr/include $FPS_CFLAGS" \
            -Dc_link_args="-flto=thin" \
            -Dcpp_link_args="-flto=thin"

      - name: Compile Vulkan Driver
        run: |
          cd mesa_src
          ninja -C build-android src/freedreno/vulkan/libvulkan_freedreno.so

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: turnip-a8xx
          path: mesa_src/build-android/src/freedreno/vulkan/libvulkan_freedreno.so
